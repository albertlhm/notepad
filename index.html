<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Notebook â€” Cloud & Local</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --text-secondary: #475569;
      --muted: #64748b;
      --accent: #7c3aed;
      --accent-light: #a78bfa;
      --border: #e2e8f0;
      --shadow: rgba(15, 23, 42, 0.08);
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
      
      --font-weight-normal: 450;
      --font-weight-medium: 550;
      --font-weight-bold: 650;
      --font-weight-heavy: 700;
      
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 12px;
    }
    
    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f8fafc;
      --text-secondary: #cbd5e1;
      --muted: #94a3b8;
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      --border: #334155;
      --shadow: rgba(2, 6, 23, 0.3);
      --danger: #f87171;
      --success: #34d399;
      --warning: #fbbf24;
      --info: #60a5fa;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Inter, "PingFang SC", "Noto Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.4s ease, color 0.4s ease;
      font-weight: var(--font-weight-normal);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .app {
      max-width: 1080px;
      margin: 28px auto;
      padding: 20px;
    }
    
    header {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    
    .brand {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent), #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: var(--font-weight-heavy);
      font-size: 20px;
      box-shadow: 0 8px 24px rgba(124, 58, 237, 0.3);
      transition: transform 0.3s ease;
    }
    
    .logo:hover {
      transform: scale(1.05);
    }
    
    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: var(--font-weight-bold);
      background: linear-gradient(135deg, var(--accent), #4f46e5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .btn {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      box-shadow: 0 4px 12px var(--shadow);
      transition: all 0.3s ease;
      font-weight: var(--font-weight-medium);
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(124, 58, 237, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .btn-primary:hover {
      background: var(--accent-light);
      border-color: var(--accent-light);
    }
    
    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border-color: rgba(239, 68, 68, 0.2);
    }
    
    .btn-danger:hover {
      background: var(--danger);
      color: white;
    }
    
    .btn-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
      border-color: rgba(245, 158, 11, 0.2);
    }
    
    .btn-warning:hover {
      background: var(--warning);
      color: white;
    }
    
    .btn-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border-color: rgba(16, 185, 129, 0.2);
    }
    
    .btn-success:hover {
      background: var(--success);
      color: white;
    }
    
    .btn-info {
      background: rgba(59, 130, 246, 0.1);
      color: var(--info);
      border-color: rgba(59, 130, 246, 0.2);
    }
    
    .btn-info:hover {
      background: var(--info);
      color: white;
    }
    
    .search {
      flex: 1;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .topbar {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      align-items: center;
    }
    
    .timecard {
      padding: 16px;
      border-radius: var(--radius-lg);
      background: var(--card);
      box-shadow: 0 6px 18px var(--shadow);
      min-width: 240px;
      border: 1px solid var(--border);
    }
    
    .timebig {
      font-weight: var(--font-weight-heavy);
      font-size: 18px;
      margin-bottom: 4px;
      color: var(--text);
    }
    
    .lunar {
      font-size: 14px;
      color: var(--muted);
      font-weight: var(--font-weight-normal);
    }
    
    main {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 24px;
      margin-top: 24px;
    }
    
    .left {
      min-height: 200px;
    }
    
    .noteEditor {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: 0 6px 18px var(--shadow);
      margin-bottom: 24px;
    }
    
    .noteEditor input,
    .noteEditor textarea {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      background: transparent;
      color: var(--text);
      font-weight: var(--font-weight-normal);
      transition: all 0.3s ease;
      font-size: 15px;
    }
    
    .noteEditor input:focus,
    .noteEditor textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }
    
    .noteEditor input::placeholder,
    .noteEditor textarea::placeholder {
      color: var(--muted);
      font-weight: var(--font-weight-normal);
    }
    
    .noteList {
      margin-top: 14px;
      display: grid;
      gap: 14px;
    }
    
    .note {
      background: var(--card);
      padding: 18px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px var(--shadow);
      transition: all 0.3s ease;
    }
    
    .note:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px var(--shadow);
    }
    
    .meta {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      align-items: center;
      font-weight: var(--font-weight-normal);
    }
    
    .pill {
      background: rgba(0, 0, 0, 0.06);
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: var(--font-weight-medium);
    }
    
    aside {
      position: sticky;
      top: 22px;
      height: fit-content;
    }
    
    .reminderList {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 14px;
    }
    
    .reminderTime {
      color: var(--accent);
      font-weight: var(--font-weight-bold);
      animation: pulse 2s infinite ease-in-out;
    }
    
    .reminderAlert {
      color: var(--danger);
      font-weight: var(--font-weight-bold);
      animation: alertPulse 1s infinite ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: .8;
      }
      50% {
        opacity: 1;
      }
    }
    
    @keyframes alertPulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    footer {
      opacity: 0.8;
      font-size: 14px;
      margin-top: 28px;
      color: var(--muted);
      font-weight: var(--font-weight-normal);
      text-align: center;
      padding: 16px;
    }
    
    /* å“åº”å¼å¸ƒå±€ä¼˜åŒ– */
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
      aside {
        position: static;
        order: 1; /* å°†ä¾§è¾¹æ ç§»åˆ°ä¸»å†…å®¹ä¸Šæ–¹ */
      }
      .left {
        order: 2; /* å°†å·¦ä¾§å†…å®¹ç§»åˆ°ä¾§è¾¹æ ä¸‹æ–¹ */
      }
      
      /* åœ¨å°å±å¹•ä¸Šä¼˜åŒ–é¡¶éƒ¨æ å¸ƒå±€ */
      .topbar {
        flex-wrap: wrap;
      }
      .timecard {
        min-width: auto;
        flex: 1;
      }
      
      /* ä¼˜åŒ–æœç´¢æ¡†åœ¨å°å±å¹•ä¸Šçš„æ˜¾ç¤º */
      .search {
        min-width: auto;
      }
      
      /* ä¼˜åŒ–æ§åˆ¶æŒ‰é’®åœ¨å°å±å¹•ä¸Šçš„æ˜¾ç¤º */
      .controls {
        flex-wrap: wrap;
        justify-content: flex-end;
      }
    }
    
    /* åœ¨å°å±å¹•ä¸Šè¿›ä¸€æ­¥ä¼˜åŒ–å¸ƒå±€ */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .search {
        order: 1;
        width: 100%;
        margin-top: 12px;
      }
      
      .app {
        padding: 16px;
        margin: 16px auto;
      }
      
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .timecard {
        width: 100%;
      }
    }
    
    /* åœ¨éå¸¸å°çš„å±å¹•ä¸Šè¿›ä¸€æ­¥ä¼˜åŒ– */
    @media (max-width: 480px) {
      .brand {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .user-menu {
        align-self: flex-end;
      }
      
      .note .meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .note .meta .pill {
        margin-bottom: 4px;
      }
    }
    
    .note,
    .timecard,
    .noteEditor {
      transition: all 220ms cubic-bezier(.2, .9, .2, 1);
    }
    
    .note.done {
      opacity: 0.7;
      border-left: 4px solid var(--accent);
    }
    
    .note.done .note-title {
      text-decoration: line-through;
    }
    
    .reminder-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .reminder-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }
    
    .reminder-item.alert {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--danger);
    }
    
    .reminder-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
    }
    
    .reminder-indicator.alert {
      background: var(--danger);
      animation: alertPulse 1s infinite;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .file-input {
      display: none;
    }
    
    .import-export {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .stats {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .stat {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: var(--card);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: var(--font-weight-bold);
      color: var(--accent);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 500px;
      border: 1px solid var(--border);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      font-weight: var(--font-weight-bold);
      font-size: 18px;
      color: var(--text);
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: var(--font-weight-medium);
      color: var(--text);
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size: 15px;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }
    
    /* ç™»å½•ç›¸å…³æ ·å¼ */
    .auth-modal {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .auth-container {
      background: var(--card);
      padding: 32px;
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--border);
    }
    
    .auth-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .auth-logo {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      background: linear-gradient(135deg, var(--accent), #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: var(--font-weight-heavy);
      font-size: 28px;
      box-shadow: 0 8px 24px rgba(124, 58, 237, 0.3);
      margin: 0 auto 16px;
    }
    
    .auth-title {
      font-weight: var(--font-weight-bold);
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--text);
    }
    
    .auth-subtitle {
      color: var(--muted);
      font-size: 14px;
    }
    
    .auth-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: var(--font-weight-medium);
      color: var(--muted);
      transition: all 0.3s ease;
    }
    
    .auth-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    
    .auth-form {
      display: none;
    }
    
    .auth-form.active {
      display: block;
    }
    
    .auth-footer {
      text-align: center;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 14px;
    }
    
    .auth-footer a {
      color: var(--accent);
      text-decoration: none;
      font-weight: var(--font-weight-medium);
    }
    
    .auth-footer a:hover {
      text-decoration: underline;
    }
    
    .user-menu {
      position: relative;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: var(--font-weight-bold);
      cursor: pointer;
    }
    
    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--card);
      border-radius: var(--radius-md);
      box-shadow: 0 8px 24px var(--shadow);
      border: 1px solid var(--border);
      padding: 8px;
      min-width: 180px;
      z-index: 100;
      display: none;
    }
    
    .user-dropdown.active {
      display: block;
    }
    
    .user-dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text);
      text-decoration: none;
    }
    
    .user-dropdown-item:hover {
      background: rgba(124, 58, 237, 0.1);
    }
    
    .user-dropdown-item.danger {
      color: var(--danger);
    }
    
    .user-dropdown-item.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    .sync-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    
    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    
    .sync-indicator.syncing {
      background: var(--warning);
      animation: pulse 1.5s infinite;
    }
    
    .sync-indicator.error {
      background: var(--danger);
    }
    
    .sync-indicator.local {
      background: var(--info);
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(124, 58, 237, 0.1);
      border-left: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
      padding: 12px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .auth-optional {
      position: absolute;
      top: 20px;
      right: 20px;
    }
  </style>
</head>
<body>
  <!-- ç™»å½•æ¨¡æ€æ¡†ï¼ˆå¯é€‰ï¼‰ -->
  <div class="auth-modal" id="authModal">
    <div class="auth-container">
      <div class="auth-optional">
        <button class="btn" id="skipAuth">Skip & Use Locally</button>
      </div>
      <div class="auth-header">
        <div class="auth-logo">ç¬”</div>
        <div class="auth-title" data-t="authTitle">Simple Notebook</div>
        <div class="auth-subtitle" data-t="authSubtitle">Login for cloud sync, or use locally</div>
      </div>
      
      <div class="auth-tabs">
        <button class="auth-tab active" id="loginTab" data-t="loginTab">Login</button>
        <button class="auth-tab" id="registerTab" data-t="registerTab">Register</button>
      </div>
      
      <div id="authError" class="error-message" style="display: none;"></div>
      
      <form class="auth-form active" id="loginForm">
        <div class="form-group">
          <label for="loginEmail" data-t="emailLabel">Email</label>
          <input type="email" id="loginEmail" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="loginPassword" data-t="passwordLabel">Password</label>
          <input type="password" id="loginPassword" class="form-control" required>
        </div>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe" style="display: inline; margin-left: 6px;" data-t="rememberMe">Remember me</label>
          </div>
          <a href="#" id="forgotPassword" data-t="forgotPassword">Forgot password?</a>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="loginBtn">
          <span data-t="loginBtn">Login</span>
          <div class="spinner" style="display: none; width: 16px; height: 16px;"></div>
        </button>
      </form>
      
      <form class="auth-form" id="registerForm">
        <div class="form-group">
          <label for="registerName" data-t="nameLabel">Full Name</label>
          <input type="text" id="registerName" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="registerEmail" data-t="emailLabel">Email</label>
          <input type="email" id="registerEmail" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="registerPassword" data-t="passwordLabel">Password</label>
          <input type="password" id="registerPassword" class="form-control" required minlength="6">
        </div>
        <div class="form-group">
          <label for="registerConfirmPassword" data-t="confirmPasswordLabel">Confirm Password</label>
          <input type="password" id="registerConfirmPassword" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="registerBtn">
          <span data-t="registerBtn">Create Account</span>
          <div class="spinner" style="display: none; width: 16px; height: 16px;"></div>
        </button>
      </form>
      
      <div class="auth-footer">
        <div data-t="authFooter">By creating an account, you agree to our <a href="#" data-t="termsLink">Terms of Service</a></div>
      </div>
    </div>
  </div>

  <!-- ä¸»åº”ç”¨ç•Œé¢ -->
  <div class="app" id="app" data-lang="en" data-theme="light">
    <header>
      <div class="brand">
        <div class="logo">ç¬”</div>
        <div>
          <h1 data-t="title">Simple Notebook</h1>
          <div style="font-size:14px;color:var(--muted)" data-t="subtitle">Cloud Sync Â· Lightweight Â· Search Â· Reminders</div>
        </div>
      </div>
      <div class="controls">
        <div class="search btn" style="min-width:280px;display:flex;align-items:center;">
          <input id="q" placeholder="Search notes" style="flex:1;border:0;background:transparent;outline:none;font-size:14px;color:var(--text)" />
          <button class="btn" id="clear">Clear</button>
        </div>
        <div class="sync-status" id="syncStatus">
          <div class="sync-indicator local" id="syncIndicator"></div>
          <span id="syncText" data-t="local">Local</span>
        </div>
        <div class="user-menu">
          <div class="user-avatar" id="userAvatar">?</div>
          <div class="user-dropdown" id="userDropdown">
            <div class="user-dropdown-item" id="loginLink">
              <span data-t="login">Login for Cloud Sync</span>
            </div>
            <div class="user-dropdown-item" id="exportLink">
              <span data-t="exportData">Export Data</span>
            </div>
            <div class="user-dropdown-item" id="importLink">
              <span data-t="importData">Import Data</span>
            </div>
          </div>
        </div>
        <div class="btn" id="lang">ä¸­æ–‡</div>
        <div class="btn" id="theme">ğŸŒ™</div>
      </div>
    </header>
    <div class="topbar">
      <div class="timecard">
        <div class="timebig" id="datetime">--</div>
        <div class="lunar" id="lunar">Lunar: --</div>
      </div>
      <div style="flex:1"></div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="btn" id="newNote">New Note</div>
        <div class="btn" id="syncNow" style="display:none">Sync Now</div>
        <input type="file" id="fileInput" class="file-input" accept=".json" />
      </div>
    </div>
    <main>
      <section class="left">
        <div class="noteEditor" id="editor">
          <input id="title" placeholder="Title" />
          <textarea id="content" rows="6" placeholder="Write something..."></textarea>
          <div style="display:flex;gap:10px;align-items:center">
            <input id="remindAt" type="datetime-local" style="padding:10px;border-radius:var(--radius-md);border:1px solid var(--border);background:transparent;color:var(--text)" />
            <button class="btn" id="save">Save</button>
            <div style="flex:1"></div>
            <div style="font-size:13px;color:var(--muted)" data-t="help">Each note stores creation date. Set reminders.</div>
          </div>
        </div>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="totalNotes">0</div>
            <div class="stat-label">Total Notes</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="activeReminders">0</div>
            <div class="stat-label">Active Reminders</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="completedNotes">0</div>
            <div class="stat-label">Completed</div>
          </div>
        </div>
        <div class="noteList" id="notes"></div>
        <!-- æ–°å¢å·²å®Œæˆç¬”è®°åŒºåŸŸ -->
        <div class="completed-section" id="completedSection" style="display:none">
          <div class="section-title" data-t="completedNotes">Completed Notes</div>
          <div class="completed-notes" id="completedNotesList"></div>
        </div>
      </section>
      <aside>
        <div style="background:var(--card);padding:16px;border-radius:var(--radius-lg);border:1px solid var(--border);box-shadow:0 4px 12px var(--shadow)">
          <div style="font-weight:700;font-size:16px;margin-bottom:8px" data-t="remindersTitle">Reminders</div>
          <div class="reminderList" id="reminders"></div>
        </div>
        <div style="background:var(--card);padding:16px;border-radius:var(--radius-lg);border:1px solid var(--border);box-shadow:0 4px 12px var(--shadow);margin-top:16px">
          <div style="font-weight:700;font-size:16px;margin-bottom:8px" data-t="infoTitle">Info</div>
          <div style="color:var(--muted);font-size:14px;margin-top:8px" id="storageInfo" data-t="localStorageInfo">Your notes are stored locally in your browser.</div>
          <div style="color:var(--muted);font-size:12px;margin-top:8px;padding:8px;background:rgba(0,0,0,0.05);border-radius:var(--radius-md)">
            ğŸ’¡ <span data-t="notificationTip">Tip: First time setting a reminder will request notification permission, please allow browser to send desktop notifications</span>
          </div>
        </div>
      </aside>
    </main>
    <footer data-t="footer">Simple Notebook â€” Use locally or login for cloud sync Â· Beautiful UI Â· Supports English/Chinese</footer>
  </div>

  <!-- è®¾ç½®æé†’æ¨¡æ€æ¡† -->
  <div class="modal" id="reminderModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="reminderModalTitle">Set Reminder</div>
        <button class="close-modal" id="closeReminderModal">&times;</button>
      </div>
      <div class="form-group">
        <label for="reminderDateTime" data-t="reminderTimeLabel">Reminder Time</label>
        <input type="datetime-local" id="reminderDateTime" class="form-control">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" id="cancelReminder" data-t="cancel">Cancel</button>
        <button class="btn" id="saveReminder" data-t="saveReminder">Save Reminder</button>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘ç¬”è®°æ¨¡æ€æ¡† -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="editModalTitle">Edit Note</div>
        <button class="close-modal" id="closeEditModal">&times;</button>
      </div>
      <div class="form-group">
        <label for="editTitle" data-t="titleLabel">Title</label>
        <input type="text" id="editTitle" class="form-control">
      </div>
      <div class="form-group">
        <label for="editContent" data-t="contentLabel">Content</label>
        <textarea id="editContent" rows="6" class="form-control"></textarea>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" id="cancelEdit" data-t="cancel">Cancel</button>
        <button class="btn btn-success" id="saveEdit" data-t="saveEdit">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // Firebaseé…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyC8o4g-Tx51lPWaXKw0MxeDwtkOET03tu8",
      authDomain: "simple-notebook-1043d.firebaseapp.com",
      projectId: "simple-notebook-1043d",
      storageBucket: "simple-notebook-1043d.firebasestorage.app",
      messagingSenderId: "1021479179837",
      appId: "1:1021479179837:web:acffb829adaf7136b73c54",
      measurementId: "G-3MRF1J3E1W"
    };

    // åˆå§‹åŒ–Firebase
    let auth, db;
    try {
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }

    // åº”ç”¨çŠ¶æ€ç®¡ç†
    let currentUser = null;
    let notes = [];
    let notesUnsubscribe = null;
    let currentLang = 'en';
    let theme = 'light';
    let isUsingCloud = false;
    let currentNoteId = null;

    // DOMå…ƒç´ ç®¡ç†å™¨
    const elements = {};

    // åˆå§‹åŒ–æ‰€æœ‰DOMå…ƒç´ å¼•ç”¨
    function initializeElements() {
      // ä¸»åº”ç”¨å…ƒç´ 
      elements.app = document.getElementById('app');
      elements.authModal = document.getElementById('authModal');
      elements.authError = document.getElementById('authError');
      elements.loginForm = document.getElementById('loginForm');
      elements.registerForm = document.getElementById('registerForm');
      elements.loginBtn = document.getElementById('loginBtn');
      elements.registerBtn = document.getElementById('registerBtn');
      elements.userAvatar = document.getElementById('userAvatar');
      elements.userDropdown = document.getElementById('userDropdown');
      elements.syncStatus = document.getElementById('syncStatus');
      elements.syncIndicator = document.getElementById('syncIndicator');
      elements.syncText = document.getElementById('syncText');
      elements.storageInfo = document.getElementById('storageInfo');
      elements.skipAuth = document.getElementById('skipAuth');
      elements.syncNow = document.getElementById('syncNow');
      elements.fileInput = document.getElementById('fileInput');
      
      // ç¬”è®°ç›¸å…³å…ƒç´ 
      elements.notes = document.getElementById('notes');
      elements.completedSection = document.getElementById('completedSection');
      elements.completedNotesList = document.getElementById('completedNotesList');
      elements.reminders = document.getElementById('reminders');
      
      // è¡¨å•å…ƒç´ 
      elements.title = document.getElementById('title');
      elements.content = document.getElementById('content');
      elements.remindAt = document.getElementById('remindAt');
      elements.save = document.getElementById('save');
      elements.newNote = document.getElementById('newNote');
      elements.q = document.getElementById('q');
      elements.clear = document.getElementById('clear');
      elements.lang = document.getElementById('lang');
      elements.theme = document.getElementById('theme');
      
      // æ—¶é—´æ˜¾ç¤ºå…ƒç´ 
      elements.datetime = document.getElementById('datetime');
      elements.lunar = document.getElementById('lunar');
      
      // æ¨¡æ€æ¡†å…ƒç´ 
      elements.reminderModal = document.getElementById('reminderModal');
      elements.reminderModalTitle = document.getElementById('reminderModalTitle');
      elements.reminderDateTime = document.getElementById('reminderDateTime');
      elements.closeReminderModal = document.getElementById('closeReminderModal');
      elements.cancelReminder = document.getElementById('cancelReminder');
      elements.saveReminder = document.getElementById('saveReminder');
      
      elements.editModal = document.getElementById('editModal');
      elements.editModalTitle = document.getElementById('editModalTitle');
      elements.editTitle = document.getElementById('editTitle');
      elements.editContent = document.getElementById('editContent');
      elements.closeEditModal = document.getElementById('closeEditModal');
      elements.cancelEdit = document.getElementById('cancelEdit');
      elements.saveEdit = document.getElementById('saveEdit');
      
      // ç»Ÿè®¡å…ƒç´ 
      elements.totalNotes = document.getElementById('totalNotes');
      elements.activeReminders = document.getElementById('activeReminders');
      elements.completedNotes = document.getElementById('completedNotes');
      
      // éªŒè¯å¿…éœ€å…ƒç´ 
      const requiredElements = ['app', 'authModal', 'userAvatar', 'userDropdown', 'notes', 'datetime', 'lunar'];
      for (const key of requiredElements) {
        if (!elements[key]) {
          console.warn(`Required element not found: ${key}`);
        }
      }
    }

    // UIæ–‡æœ¬
    const UI = {
      cn: {
        authTitle: 'ç®€çº¦ç¬”è®°',
        authSubtitle: 'ç™»å½•ä½¿ç”¨äº‘ç«¯åŒæ­¥ï¼Œæˆ–æœ¬åœ°ä½¿ç”¨',
        loginTab: 'ç™»å½•',
        registerTab: 'æ³¨å†Œ',
        emailLabel: 'é‚®ç®±',
        passwordLabel: 'å¯†ç ',
        nameLabel: 'å§“å',
        confirmPasswordLabel: 'ç¡®è®¤å¯†ç ',
        rememberMe: 'è®°ä½æˆ‘',
        forgotPassword: 'å¿˜è®°å¯†ç ?',
        loginBtn: 'ç™»å½•',
        registerBtn: 'åˆ›å»ºè´¦æˆ·',
        authFooter: 'åˆ›å»ºè´¦æˆ·å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„',
        termsLink: 'æœåŠ¡æ¡æ¬¾',
        login: 'ç™»å½•ä½¿ç”¨äº‘ç«¯åŒæ­¥',
        exportData: 'å¯¼å‡ºæ•°æ®',
        importData: 'å¯¼å…¥æ•°æ®',
        logout: 'é€€å‡ºç™»å½•',
        synced: 'å·²åŒæ­¥',
        syncing: 'åŒæ­¥ä¸­',
        syncError: 'åŒæ­¥å¤±è´¥',
        local: 'æœ¬åœ°',
        title: 'ç®€çº¦ç¬”è®°',
        subtitle: 'äº‘ç«¯åŒæ­¥ Â· è½»é‡ Â· æ”¯æŒæœç´¢ Â· æé†’',
        help: 'æ¯æ¡ç¬”è®°ä¼šä¿å­˜åˆ›å»ºæ—¶é—´ï¼Œå¯è®¾ç½®æé†’',
        searchPlaceholder: 'æœç´¢ç¬”è®°',
        newNote: 'æ–°å»ºç¬”è®°',
        save: 'ä¿å­˜',
        clear: 'æ¸…é™¤',
        titlePlaceholder: 'æ ‡é¢˜',
        contentPlaceholder: 'å†™ç‚¹ä»€ä¹ˆ...',
        remindersTitle: 'æé†’ä¸­å¿ƒ',
        infoTitle: 'è¯´æ˜',
        localStorageInfo: 'æ‚¨çš„ç¬”è®°å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ã€‚',
        cloudStorageInfo: 'æ‚¨çš„ç¬”è®°å®‰å…¨å­˜å‚¨åœ¨äº‘ç«¯ï¼Œå¹¶åœ¨æ‰€æœ‰è®¾å¤‡é—´åŒæ­¥ã€‚',
        noReminders: 'æš‚æ— æé†’',
        noNotes: 'æš‚æ— ç¬”è®°ï¼Œåˆ›å»ºç¬¬ä¸€æ¡ç¬”è®°å¼€å§‹ä½¿ç”¨',
        deleteConfirm: 'ç¡®è®¤åˆ é™¤è¿™æ¡ç¬”è®°ï¼Ÿ',
        deleteReminderConfirm: 'ç¡®è®¤åˆ é™¤è¿™ä¸ªæé†’ï¼Ÿ',
        done: 'æ ‡ä¸ºå®Œæˆ',
        completed: 'å·²å®Œæˆ',
        delete: 'åˆ é™¤',
        edit: 'ç¼–è¾‘',
        reminder: 'æé†’',
        noReminder: 'æ— æé†’',
        setReminder: 'è®¾ç½®æé†’',
        editReminder: 'ä¿®æ”¹æé†’',
        reminderModalTitle: 'è®¾ç½®æé†’',
        editModalTitle: 'ç¼–è¾‘ç¬”è®°',
        cancel: 'å–æ¶ˆ',
        saveReminder: 'ä¿å­˜æé†’',
        saveEdit: 'ä¿å­˜ä¿®æ”¹',
        footer: 'Simple Notebook â€” æœ¬åœ°ä½¿ç”¨æˆ–ç™»å½•äº‘ç«¯åŒæ­¥ Â· UI ç²¾ç¾ Â· æ”¯æŒä¸­è‹±',
        importSuccess: 'æ•°æ®å¯¼å…¥æˆåŠŸï¼',
        importError: 'å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼',
        reminderTimeLabel: 'æé†’æ—¶é—´',
        titleLabel: 'æ ‡é¢˜',
        contentLabel: 'å†…å®¹',
        notificationTip: 'æç¤ºï¼šé¦–æ¬¡è®¾ç½®æé†’æ—¶ä¼šè¯·æ±‚é€šçŸ¥æƒé™ï¼Œè¯·å…è®¸æµè§ˆå™¨å‘é€æ¡Œé¢é€šçŸ¥',
        totalNotes: 'æ€»ç¬”è®°',
        activeReminders: 'æ´»è·ƒæé†’',
        completedNotes: 'å·²å®Œæˆ',
        undoComplete: 'æ’¤é”€å®Œæˆ',
        completedNotesSection: 'å·²å®Œæˆç¬”è®°',
        skipAuth: 'è·³è¿‡ï¼Œæœ¬åœ°ä½¿ç”¨',
        syncNow: 'ç«‹å³åŒæ­¥'
      },
      en: {
        authTitle: 'Simple Notebook',
        authSubtitle: 'Login for cloud sync, or use locally',
        loginTab: 'Login',
        registerTab: 'Register',
        emailLabel: 'Email',
        passwordLabel: 'Password',
        nameLabel: 'Full Name',
        confirmPasswordLabel: 'Confirm Password',
        rememberMe: 'Remember me',
        forgotPassword: 'Forgot password?',
        loginBtn: 'Login',
        registerBtn: 'Create Account',
        authFooter: 'By creating an account, you agree to our',
        termsLink: 'Terms of Service',
        login: 'Login for Cloud Sync',
        exportData: 'Export Data',
        importData: 'Import Data',
        logout: 'Logout',
        synced: 'Synced',
        syncing: 'Syncing',
        syncError: 'Sync Error',
        local: 'Local',
        title: 'Simple Notebook',
        subtitle: 'Cloud Sync Â· Lightweight Â· Search Â· Reminders',
        help: 'Each note stores creation date. Set reminders.',
        searchPlaceholder: 'Search notes',
        newNote: 'New Note',
        save: 'Save',
        clear: 'Clear',
        titlePlaceholder: 'Title',
        contentPlaceholder: 'Write something...',
        remindersTitle: 'Reminders',
        infoTitle: 'Info',
        localStorageInfo: 'Your notes are stored locally in your browser.',
        cloudStorageInfo: 'Your notes are securely stored in the cloud and synced across all your devices.',
        noReminders: 'No reminders',
        noNotes: 'No notes yet, create your first note to get started',
        deleteConfirm: 'Confirm delete this note?',
        deleteReminderConfirm: 'Confirm delete this reminder?',
        done: 'Mark as done',
        completed: 'Completed',
        delete: 'Delete',
        edit: 'Edit',
        reminder: 'Reminder',
        noReminder: 'No reminder',
        setReminder: 'Set Reminder',
        editReminder: 'Edit Reminder',
        reminderModalTitle: 'Set Reminder',
        editModalTitle: 'Edit Note',
        cancel: 'Cancel',
        saveReminder: 'Save Reminder',
        saveEdit: 'Save Changes',
        footer: 'Simple Notebook â€” Use locally or login for cloud sync Â· Beautiful UI Â· Supports English/Chinese',
        importSuccess: 'Data imported successfully!',
        importError: 'Import failed, please check file format',
        reminderTimeLabel: 'Reminder Time',
        titleLabel: 'Title',
        contentLabel: 'Content',
        notificationTip: 'Tip: First time setting a reminder will request notification permission, please allow browser to send desktop notifications',
        totalNotes: 'Total Notes',
        activeReminders: 'Active Reminders',
        completedNotes: 'Completed',
        undoComplete: 'Undo Complete',
        completedNotesSection: 'Completed Notes',
        skipAuth: 'Skip & Use Locally',
        syncNow: 'Sync Now'
      }
    };

    // æœ¬åœ°å­˜å‚¨å‡½æ•°
    function loadLocalNotes() {
      const localNotes = localStorage.getItem('simple_notes_local');
      if (localNotes) {
        notes = JSON.parse(localNotes);
      } else {
        notes = [];
      }
      renderNotes();
      renderCompletedNotes();
      renderReminders();
      updateStats();
    }

    function saveLocalNotes() {
      localStorage.setItem('simple_notes_local', JSON.stringify(notes));
    }

    // è®¤è¯ç›¸å…³å‡½æ•°
    function showAuthModal() {
      if (elements.authModal) elements.authModal.style.display = 'flex';
    }

    function hideAuthModal() {
      if (elements.authModal) elements.authModal.style.display = 'none';
    }

    function showAuthError(message) {
      if (elements.authError) {
        elements.authError.textContent = message;
        elements.authError.style.display = 'block';
      }
    }

    function hideAuthError() {
      if (elements.authError) elements.authError.style.display = 'none';
    }

    function setLoading(button, isLoading) {
      if (!button) return;
      
      const spinner = button.querySelector('.spinner');
      const text = button.querySelector('span');
      
      if (isLoading) {
        if (spinner) spinner.style.display = 'block';
        if (text) text.style.display = 'none';
        button.disabled = true;
      } else {
        if (spinner) spinner.style.display = 'none';
        if (text) text.style.display = 'inline';
        button.disabled = false;
      }
    }

    function setSyncStatus(status) {
      if (!elements.syncIndicator || !elements.syncText || !elements.storageInfo) return;
      
      const pack = currentLang === 'cn' ? UI.cn : UI.en;
      
      elements.syncIndicator.className = 'sync-indicator';
      if (status === 'synced') {
        elements.syncIndicator.classList.add('synced');
        elements.syncText.textContent = pack.synced;
        elements.storageInfo.textContent = pack.cloudStorageInfo;
        if (elements.syncNow) elements.syncNow.style.display = 'none';
      } else if (status === 'syncing') {
        elements.syncIndicator.classList.add('syncing');
        elements.syncText.textContent = pack.syncing;
        elements.storageInfo.textContent = pack.cloudStorageInfo;
        if (elements.syncNow) elements.syncNow.style.display = 'none';
      } else if (status === 'error') {
        elements.syncIndicator.classList.add('error');
        elements.syncText.textContent = pack.syncError;
        elements.storageInfo.textContent = pack.cloudStorageInfo;
        if (elements.syncNow) elements.syncNow.style.display = 'block';
      } else if (status === 'local') {
        elements.syncIndicator.classList.add('local');
        elements.syncText.textContent = pack.local;
        elements.storageInfo.textContent = pack.localStorageInfo;
        if (elements.syncNow) elements.syncNow.style.display = 'none';
      }
    }

    // ä¿®å¤çš„ updateUserUI å‡½æ•°
    function updateUserUI() {
      if (!elements.userDropdown || !elements.userAvatar) return;
      
      if (currentUser) {
        elements.userAvatar.textContent = currentUser.displayName ? 
          currentUser.displayName.charAt(0).toUpperCase() : 
          currentUser.email.charAt(0).toUpperCase();
        
        elements.userDropdown.innerHTML = `
          <div class="user-dropdown-item" id="profileLink">
            <span>${currentUser.displayName || currentUser.email}</span>
          </div>
          <div class="user-dropdown-item" id="exportLink">
            <span data-t="exportData">Export Data</span>
          </div>
          <div class="user-dropdown-item danger" id="logoutLink">
            <span data-t="logout">Logout</span>
          </div>
        `;
        
        // å®‰å…¨ç»‘å®šäº‹ä»¶
        setTimeout(() => {
          const logoutLink = document.getElementById('logoutLink');
          if (logoutLink) logoutLink.addEventListener('click', logout);
        }, 0);
      } else {
        elements.userAvatar.textContent = '?';
        elements.userDropdown.innerHTML = `
          <div class="user-dropdown-item" id="loginLink">
            <span data-t="login">Login for Cloud Sync</span>
          </div>
          <div class="user-dropdown-item" id="exportLink">
            <span data-t="exportData">Export Data</span>
          </div>
          <div class="user-dropdown-item" id="importLink">
            <span data-t="importData">Import Data</span>
          </div>
        `;
        
        // å®‰å…¨ç»‘å®šäº‹ä»¶
        setTimeout(() => {
          const loginLink = document.getElementById('loginLink');
          if (loginLink) loginLink.addEventListener('click', showAuthModal);
        }, 0);
      }
      
      // å®‰å…¨ç»‘å®šå¯¼å‡ºå¯¼å…¥äº‹ä»¶
      setTimeout(() => {
        const exportLink = document.getElementById('exportLink');
        if (exportLink) exportLink.addEventListener('click', exportAllNotes);
        
        const importLink = document.getElementById('importLink');
        if (importLink) {
          importLink.addEventListener('click', () => {
            if (elements.fileInput) elements.fileInput.click();
          });
        }
      }, 0);
    }

    // Firebaseè®¤è¯ç›‘å¬
    auth.onAuthStateChanged((user) => {
      console.log("Auth state changed:", user);
      if (user) {
        currentUser = user;
        isUsingCloud = true;
        updateUserUI();
        loadCloudNotes();
        hideAuthModal();
        setSyncStatus('syncing');
        
        // æ¸…ç©ºç™»å½•è¡¨å•
        if (elements.loginEmail) elements.loginEmail.value = '';
        if (elements.loginPassword) elements.loginPassword.value = '';
      } else {
        currentUser = null;
        isUsingCloud = false;
        if (notesUnsubscribe) {
          notesUnsubscribe();
          notesUnsubscribe = null;
        }
        updateUserUI();
        setSyncStatus('local');
      }
    });

    // ç”¨æˆ·æ³¨å†Œ
    function setupRegisterForm() {
      if (!elements.registerForm) return;
      
      elements.registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('registerName')?.value.trim() || '';
        const email = document.getElementById('registerEmail')?.value.trim() || '';
        const password = document.getElementById('registerPassword')?.value || '';
        const confirmPassword = document.getElementById('registerConfirmPassword')?.value || '';
        
        // éªŒè¯è¾“å…¥
        if (!name || !email || !password || !confirmPassword) {
          showAuthError('Please fill in all fields');
          return;
        }
        
        if (password !== confirmPassword) {
          showAuthError('Passwords do not match');
          return;
        }
        
        if (password.length < 6) {
          showAuthError('Password must be at least 6 characters');
          return;
        }
        
        if (!validateEmail(email)) {
          showAuthError('Please enter a valid email address');
          return;
        }
        
        setLoading(elements.registerBtn, true);
        hideAuthError();
        
        try {
          console.log("Attempting to register user:", email);
          
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          console.log("User registered successfully:", userCredential.user);
          
          // æ›´æ–°ç”¨æˆ·èµ„æ–™
          await userCredential.user.updateProfile({
            displayName: name
          });
          
          console.log("User profile updated successfully");
          
          // åˆ›å»ºç”¨æˆ·æ–‡æ¡£ï¼ˆå¯é€‰ï¼Œä¸æ˜¯å¿…éœ€çš„ï¼‰
          try {
            await db.collection('users').doc(userCredential.user.uid).set({
              name: name,
              email: email,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("User document created successfully");
          } catch (dbError) {
            console.warn("Could not create user document:", dbError);
            // ç»§ç»­æ‰§è¡Œï¼Œè¿™ä¸æ˜¯å…³é”®é”™è¯¯
          }
          
          // æ³¨å†ŒæˆåŠŸï¼Œè®¤è¯çŠ¶æ€ç›‘å¬å™¨ä¼šè‡ªåŠ¨å¤„ç†åç»­é€»è¾‘
          
        } catch (error) {
          console.error("Registration error:", error);
          
          // æä¾›æ›´å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
          let errorMessage = error.message;
          if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'This email is already registered. Please use a different email or login.';
          } else if (error.code === 'auth/weak-password') {
            errorMessage = 'Password is too weak. Please use a stronger password.';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email address. Please check your email.';
          } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = 'Email/password accounts are not enabled. Please contact support.';
          }
          
          showAuthError(errorMessage);
          setLoading(elements.registerBtn, false);
        }
      });
    }

    // ç”¨æˆ·ç™»å½•
    function setupLoginForm() {
      if (!elements.loginForm) return;
      
      elements.loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail')?.value.trim() || '';
        const password = document.getElementById('loginPassword')?.value || '';
        
        // éªŒè¯è¾“å…¥
        if (!email || !password) {
          showAuthError('Please fill in all fields');
          return;
        }
        
        if (!validateEmail(email)) {
          showAuthError('Please enter a valid email address');
          return;
        }
        
        setLoading(elements.loginBtn, true);
        hideAuthError();
        
        try {
          console.log("Attempting to login user:", email);
          
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          console.log("User logged in successfully:", userCredential.user);
          
          // ç™»å½•æˆåŠŸï¼Œè®¤è¯çŠ¶æ€ç›‘å¬å™¨ä¼šè‡ªåŠ¨å¤„ç†åç»­é€»è¾‘
          
        } catch (error) {
          console.error("Login error:", error);
          
          // æä¾›æ›´å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
          let errorMessage = error.message;
          if (error.code === 'auth/invalid-login-credentials') {
            errorMessage = 'Invalid email or password. Please check your credentials.';
          } else if (error.code === 'auth/user-not-found') {
            errorMessage = 'No account found with this email. Please register first.';
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'Incorrect password. Please try again.';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email address. Please check your email.';
          } else if (error.code === 'auth/user-disabled') {
            errorMessage = 'This account has been disabled. Please contact support.';
          } else if (error.code === 'auth/too-many-requests') {
            errorMessage = 'Too many failed login attempts. Please try again later.';
          }
          
          showAuthError(errorMessage);
          setLoading(elements.loginBtn, false);
        }
      });
    }

    // è¾…åŠ©å‡½æ•°ï¼šéªŒè¯é‚®ç®±æ ¼å¼
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // ç”¨æˆ·é€€å‡º
    function logout() {
      auth.signOut();
      // åˆ‡æ¢å›æœ¬åœ°å­˜å‚¨
      loadLocalNotes();
    }

    // åŠ è½½äº‘ç«¯ç¬”è®°
    function loadCloudNotes() {
      if (!currentUser) return;
      
      console.log("Loading cloud notes for user:", currentUser.uid);
      
      try {
        // å®æ—¶ç›‘å¬ç”¨æˆ·ç¬”è®°
        notesUnsubscribe = db.collection('notes')
          .where('userId', '==', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            notes = [];
            snapshot.forEach(doc => {
              const note = doc.data();
              note.id = doc.id;
              // è½¬æ¢Firestoreæ—¶é—´æˆ³ä¸ºDateå¯¹è±¡
              if (note.createdAt && note.createdAt.toDate) {
                note.createdAt = note.createdAt.toDate();
              }
              if (note.remindAt && note.remindAt.toDate) {
                note.remindAt = note.remindAt.toDate();
              }
              notes.push(note);
            });
            
            console.log("Loaded", notes.length, "notes from cloud");
            setSyncStatus('synced');
            renderNotes();
            renderCompletedNotes();
            renderReminders();
            updateStats();
          }, (error) => {
            console.error('Error loading notes:', error);
            setSyncStatus('error');
          });
      } catch (error) {
        console.error('Error setting up notes listener:', error);
        setSyncStatus('error');
      }
    }

    // åˆ›å»ºç¬”è®°
    async function createNote(title, content, remindAt) {
      const noteData = {
        title: title || (currentLang === 'cn' ? '(æ— æ ‡é¢˜)' : '(No Title)'),
        content: content || '',
        createdAt: new Date(),
        remindAt: remindAt ? new Date(remindAt) : null,
        done: false,
        _notified: false
      };
      
      if (isUsingCloud && currentUser) {
        // äº‘ç«¯å­˜å‚¨
        noteData.userId = currentUser.uid;
        noteData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        if (noteData.remindAt) {
          noteData.remindAt = firebase.firestore.Timestamp.fromDate(new Date(remindAt));
        }
        
        try {
          await db.collection('notes').add(noteData);
          console.log("Note created successfully in cloud");
        } catch (error) {
          console.error('Error creating note in cloud:', error);
          alert('Failed to create note in cloud. Please check your connection.');
        }
      } else {
        // æœ¬åœ°å­˜å‚¨
        const note = {
          ...noteData,
          id: Date.now().toString()
        };
        notes.unshift(note);
        saveLocalNotes();
        renderNotes();
        renderCompletedNotes();
        renderReminders();
        updateStats();
      }
    }

    // æ›´æ–°ç¬”è®°
    async function updateNote(id, title, content) {
      if (isUsingCloud && currentUser) {
        try {
          await db.collection('notes').doc(id).update({
            title: title,
            content: content
          });
        } catch (error) {
          console.error('Error updating note:', error);
          alert('Failed to update note');
        }
      } else {
        const note = notes.find(n => n.id === id);
        if (note) {
          note.title = title;
          note.content = content;
          saveLocalNotes();
          renderNotes();
          renderCompletedNotes();
        }
      }
    }

    // åˆ é™¤ç¬”è®°
    async function deleteNote(id) {
      if (isUsingCloud && currentUser) {
        try {
          await db.collection('notes').doc(id).delete();
        } catch (error) {
          console.error('Error deleting note:', error);
          alert('Failed to delete note');
        }
      } else {
        notes = notes.filter(x => x.id !== id);
        saveLocalNotes();
        renderNotes();
        renderCompletedNotes();
        renderReminders();
        updateStats();
      }
    }

    // è®¾ç½®æé†’
    async function setReminder(id, remindAt) {
      const reminderDate = remindAt ? new Date(remindAt) : null;
      
      if (isUsingCloud && currentUser) {
        try {
          await db.collection('notes').doc(id).update({
            remindAt: reminderDate ? firebase.firestore.Timestamp.fromDate(reminderDate) : null,
            _notified: false
          });
        } catch (error) {
          console.error('Error setting reminder:', error);
          alert('Failed to set reminder');
        }
      } else {
        const note = notes.find(x => x.id === id);
        if (note) {
          note.remindAt = reminderDate;
          note._notified = false;
          saveLocalNotes();
          renderNotes();
          renderCompletedNotes();
          renderReminders();
        }
      }
      
      // å¦‚æœè®¾ç½®äº†æé†’ä½†é€šçŸ¥æƒé™æœªè®¾ç½®ï¼Œè¯·æ±‚æƒé™
      if (remindAt && Notification.permission === 'default') {
        requestNotificationPermission();
      }
    }

    // åˆ é™¤æé†’
    async function deleteReminder(id) {
      if (isUsingCloud && currentUser) {
        try {
          await db.collection('notes').doc(id).update({
            remindAt: null
          });
        } catch (error) {
          console.error('Error deleting reminder:', error);
          alert('Failed to delete reminder');
        }
      } else {
        const note = notes.find(x => x.id === id);
        if (note) {
          note.remindAt = null;
          saveLocalNotes();
          renderNotes();
          renderCompletedNotes();
          renderReminders();
        }
      }
    }

    // åˆ‡æ¢å®ŒæˆçŠ¶æ€
    async function toggleDone(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;
      
      if (isUsingCloud && currentUser) {
        try {
          await db.collection('notes').doc(id).update({
            done: !note.done
          });
        } catch (error) {
          console.error('Error toggling note status:', error);
          alert('Failed to update note');
        }
      } else {
        note.done = !note.done;
        saveLocalNotes();
        renderNotes();
        renderCompletedNotes();
        renderReminders();
        updateStats();
      }
    }

    // å¯¼å‡ºæ•°æ®
    function exportAllNotes() {
      const data = JSON.stringify(notes, null, 2);
      const blob = new Blob([data], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'notes_backup.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // å¯¼å…¥æ•°æ®
    function importNotes(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedNotes = JSON.parse(e.target.result);
          if (Array.isArray(importedNotes)) {
            notes = importedNotes;
            if (isUsingCloud && currentUser) {
              // å¦‚æœæ˜¯äº‘ç«¯ç”¨æˆ·ï¼Œå°†æ•°æ®åŒæ­¥åˆ°äº‘ç«¯
              syncLocalToCloud();
            } else {
              // æœ¬åœ°å­˜å‚¨
              saveLocalNotes();
              renderNotes();
              renderCompletedNotes();
              renderReminders();
              updateStats();
            }
            const pack = currentLang === 'cn' ? UI.cn : UI.en;
            alert(pack.importSuccess);
          } else {
            throw new Error('Invalid format');
          }
        } catch (error) {
          const pack = currentLang === 'cn' ? UI.cn : UI.en;
          alert(pack.importError);
        }
      };
      reader.readAsText(file);
    }

    // å°†æœ¬åœ°æ•°æ®åŒæ­¥åˆ°äº‘ç«¯
    async function syncLocalToCloud() {
      if (!currentUser) return;
      
      setSyncStatus('syncing');
      
      try {
        // æ‰¹é‡ä¸Šä¼ æœ¬åœ°ç¬”è®°åˆ°äº‘ç«¯
        const batch = db.batch();
        const localNotes = JSON.parse(localStorage.getItem('simple_notes_local') || '[]');
        
        for (const note of localNotes) {
          const noteRef = db.collection('notes').doc();
          const cloudNote = {
            userId: currentUser.uid,
            title: note.title,
            content: note.content,
            createdAt: firebase.firestore.Timestamp.fromDate(new Date(note.createdAt)),
            remindAt: note.remindAt ? firebase.firestore.Timestamp.fromDate(new Date(note.remindAt)) : null,
            done: note.done || false,
            _notified: note._notified || false
          };
          batch.set(noteRef, cloudNote);
        }
        
        await batch.commit();
        setSyncStatus('synced');
        
        // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
        localStorage.removeItem('simple_notes_local');
        
      } catch (error) {
        console.error('Error syncing to cloud:', error);
        setSyncStatus('error');
      }
    }

    // è¯·æ±‚é€šçŸ¥æƒé™
    function requestNotificationPermission() {
      if (!('Notification' in window)) {
        return;
      }
      
      if (Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    // æ£€æŸ¥æé†’
    function checkReminders() {
      const now = new Date();
      let hasActiveReminders = false;
      
      for (const note of notes) {
        if (note.remindAt && !note.done && !note._notified) {
          const remindTime = note.remindAt instanceof Date ? note.remindAt : new Date(note.remindAt);
          if (remindTime <= now) {
            notify(note);
            // æ ‡è®°ä¸ºå·²é€šçŸ¥
            if (isUsingCloud && currentUser) {
              db.collection('notes').doc(note.id).update({
                _notified: true
              });
            } else {
              note._notified = true;
              saveLocalNotes();
            }
            hasActiveReminders = true;
          }
        }
      }
      
      renderReminders();
    }
    
    setInterval(checkReminders, 30000);
    
    // é€šçŸ¥å‡½æ•°
    function notify(note) {
      const pack = currentLang === 'cn' ? UI.cn : UI.en;
      const text = (currentLang === 'cn') ? `æé†’: ${note.title}` : `Reminder: ${note.title}`;
      
      if (window.Notification && Notification.permission === 'granted') {
        new Notification(text, {
          body: note.content.substring(0, 120),
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ“</text></svg>',
          tag: `note-${note.id}`
        });
      } else {
        // å¦‚æœé€šçŸ¥æƒé™è¢«æ‹’ç»ï¼Œä½¿ç”¨alertä½œä¸ºå¤‡ç”¨
        alert(text + '\n' + note.content);
      }
    }

    // æ¸²æŸ“å‡½æ•°
    function renderNotes(filter = '') {
      if (!elements.notes) return;
      
      const activeNotes = notes.filter(n => !n.done && (n.title + ' ' + n.content).toLowerCase().includes(filter.toLowerCase()));

      if (activeNotes.length === 0) {
        const pack = currentLang === 'cn' ? UI.cn : UI.en;
        elements.notes.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M12 11v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <div>${pack.noNotes}</div>
          </div>
        `;
        return;
      }

      elements.notes.innerHTML = '';
      for (const n of activeNotes) {
        const el = document.createElement('div');
        el.className = `note`;
        
        const pack = currentLang === 'cn' ? UI.cn : UI.en;
        const createdDate = n.createdAt instanceof Date ? n.createdAt : new Date(n.createdAt);
        const remindDisplay = n.remindAt ? 
          `<span class='reminderTime'>${pack.reminder}: ${(n.remindAt instanceof Date ? n.remindAt : new Date(n.remindAt)).toLocaleString()}</span>` : 
          pack.noReminder;
          
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div class="note-title" style="font-weight:700;font-size:16px;color:var(--text)">${escapeHtml(n.title)}</div>
            <div style="text-align:right">
              <div class="pill">${createdDate.toLocaleString()}</div>
            </div>
          </div>
          <div style="margin-top:10px;color:var(--text-secondary);font-size:14px">${escapeHtml(n.content).replace(/\n/g, '<br/>')}</div>
          <div style="margin-top:12px;display:flex;gap:10px;align-items:center" class="meta">
            <div class="pill">${remindDisplay}</div>
            <div class="pill">ID:${n.id.substring(0, 8)}</div>
            <div style="flex:1"></div>
            <button class="btn btn-warning" data-action="set-reminder" data-id="${n.id}">${pack.setReminder}</button>
            <button class="btn btn-success" data-action="edit" data-id="${n.id}">${pack.edit}</button>
            <button class="btn" data-action="done" data-id="${n.id}">${pack.done}</button>
            <button class="btn btn-danger" data-action="delete" data-id="${n.id}">${pack.delete}</button>
          </div>
        `;
        elements.notes.appendChild(el);
      }
    }

    function renderCompletedNotes(filter = '') {
      if (!elements.completedSection || !elements.completedNotesList) return;
      
      const completedNotes = notes.filter(n => n.done && (n.title + ' ' + n.content).toLowerCase().includes(filter.toLowerCase()));
      
      if (completedNotes.length === 0) {
        elements.completedSection.style.display = 'none';
        return;
      }
      
      elements.completedSection.style.display = 'block';
      elements.completedNotesList.innerHTML = '';
      
      const pack = currentLang === 'cn' ? UI.cn : UI.en;
      
      // æ›´æ–°å·²å®Œæˆç¬”è®°åŒºåŸŸçš„æ ‡é¢˜
      const sectionTitle = elements.completedSection.querySelector('.section-title');
      if (sectionTitle) sectionTitle.textContent = pack.completedNotesSection;
      
      for (const n of completedNotes) {
        const el = document.createElement('div');
        el.className = `completed-note`;
        
        const createdDate = n.createdAt instanceof Date ? n.createdAt : new Date(n.createdAt);
        const remindDisplay = n.remindAt ? 
          `<span class='reminderTime'>${pack.reminder}: ${(n.remindAt instanceof Date ? n.remindAt : new Date(n.remindAt)).toLocaleString()}</span>` : 
          pack.noReminder;
          
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div class="note-title" style="font-weight:700;font-size:16px;color:var(--text)">${escapeHtml(n.title)}</div>
            <div style="text-align:right">
              <div class="pill">${createdDate.toLocaleString()}</div>
            </div>
          </div>
          <div style="margin-top:10px;color:var(--text-secondary);font-size:14px">${escapeHtml(n.content).replace(/\n/g, '<br/>')}</div>
          <div style="margin-top:12px;display:flex;gap:10px;align-items:center" class="meta">
            <div class="pill">${remindDisplay}</div>
            <div class="pill">ID:${n.id.substring(0, 8)}</div>
            <div style="flex:1"></div>
            <button class="btn btn-success" data-action="undo-done" data-id="${n.id}">${pack.undoComplete}</button>
            <button class="btn btn-danger" data-action="delete" data-id="${n.id}">${pack.delete}</button>
          </div>
        `;
        elements.completedNotesList.appendChild(el);
      }
    }

    function renderReminders() {
      if (!elements.reminders) return;
      
      const now = new Date();
      const upcoming = notes
        .filter(n => n.remindAt && !n.done)
        .sort((a, b) => {
          const aTime = a.remindAt instanceof Date ? a.remindAt : new Date(a.remindAt);
          const bTime = b.remindAt instanceof Date ? b.remindAt : new Date(b.remindAt);
          return aTime - bTime;
        });
        
      const pack = currentLang === 'cn' ? UI.cn : UI.en;
      
      if (upcoming.length === 0) {
        elements.reminders.innerHTML = `<div style="color:var(--muted);text-align:center;padding:20px">${pack.noReminders}</div>`;
        return;
      }
      
      elements.reminders.innerHTML = '';
      for (const n of upcoming) {
        const el = document.createElement('div');
        const when = n.remindAt instanceof Date ? n.remindAt : new Date(n.remindAt);
        const isAlert = when <= now;
        
        el.className = `reminder-item ${isAlert ? 'alert' : ''}`;
        el.innerHTML = `
          <div class="reminder-indicator ${isAlert ? 'alert' : ''}"></div>
          <div style="flex:1">
            <div style="font-weight:600;font-size:14px">${escapeHtml(n.title)}</div>
            <div class="${isAlert ? 'reminderAlert' : 'reminderTime'}" style="font-size:12px">${when.toLocaleString()}</div>
          </div>
          <button class="btn btn-danger" data-action="delete-reminder" data-id="${n.id}" style="padding:6px;font-size:12px">
            ${pack.delete}
          </button>
        `;
        elements.reminders.appendChild(el);
      }
    }

    function updateStats() {
      if (!elements.totalNotes || !elements.activeReminders || !elements.completedNotes) return;
      
      const total = notes.length;
      const active = notes.filter(n => n.remindAt && !n.done).length;
      const completed = notes.filter(n => n.done).length;
      
      elements.totalNotes.textContent = total;
      elements.activeReminders.textContent = active;
      elements.completedNotes.textContent = completed;
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }

    // è¯­è¨€å’Œä¸»é¢˜åŠŸèƒ½
    function applyLang() {
      const pack = currentLang === 'cn' ? UI.cn : UI.en;
      
      // æ›´æ–°æ‰€æœ‰å¸¦ data-t å±æ€§çš„å…ƒç´ 
      document.querySelectorAll('[data-t]').forEach(el => {
        const key = el.getAttribute('data-t');
        if (pack[key]) {
          el.textContent = pack[key];
        }
      });
      
      // æ›´æ–°æŒ‰é’®æ–‡æœ¬
      if (elements.newNote) elements.newNote.textContent = pack.newNote;
      if (elements.save) elements.save.textContent = pack.save;
      if (elements.clear) elements.clear.textContent = pack.clear;
      if (elements.syncNow) elements.syncNow.textContent = pack.syncNow;
      
      // æ›´æ–°å ä½ç¬¦
      if (elements.title) elements.title.placeholder = pack.titlePlaceholder;
      if (elements.content) elements.content.placeholder = pack.contentPlaceholder;
      if (elements.q) elements.q.placeholder = pack.searchPlaceholder;
      
      // æ›´æ–°åŒæ­¥çŠ¶æ€
      setSyncStatus(isUsingCloud ? 'synced' : 'local');
    }

    function applyTheme() {
      document.documentElement.setAttribute('data-theme', theme);
      if (elements.app) elements.app.setAttribute('data-theme', theme);
      if (elements.theme) elements.theme.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // ä¿®å¤çš„æ—¶é—´æ›´æ–°å‡½æ•°
    function updateClock() {
      const now = new Date();
      if (elements.datetime) {
        elements.datetime.textContent = now.toLocaleString();
      }
      if (elements.lunar) {
        elements.lunar.textContent = (currentLang === 'cn' ? 'å†œå†: ' : 'Lunar: ') + getLunarDay(now);
      }
    }

    // ä¿®å¤çš„å†œå†æ—¥æœŸè®¡ç®—å‡½æ•°
    function getLunarDay(d) {
      if (currentLang === 'en') {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return days[d.getDay()];
      }
      
      // ç®€åŒ–ç‰ˆå†œå†æ˜¾ç¤º - æ˜¾ç¤ºæ˜ŸæœŸå‡ 
      const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      return days[d.getDay()];
    }

    // è®¾ç½®ç™»å½•/æ³¨å†Œæ ‡ç­¾åˆ‡æ¢
    function setupAuthTabs() {
      const loginTab = document.getElementById('loginTab');
      const registerTab = document.getElementById('registerTab');
      
      if (loginTab) {
        loginTab.addEventListener('click', () => {
          loginTab.classList.add('active');
          if (registerTab) registerTab.classList.remove('active');
          if (elements.loginForm) elements.loginForm.classList.add('active');
          if (elements.registerForm) elements.registerForm.classList.remove('active');
          hideAuthError();
        });
      }
      
      if (registerTab) {
        registerTab.addEventListener('click', () => {
          if (loginTab) loginTab.classList.remove('active');
          registerTab.classList.add('active');
          if (elements.loginForm) elements.loginForm.classList.remove('active');
          if (elements.registerForm) elements.registerForm.classList.add('active');
          hideAuthError();
        });
      }
    }

    // è®¾ç½®ç¬”è®°æ“ä½œäº‹ä»¶
    function setupNoteEvents() {
      // ç¬”è®°æ“ä½œäº‹ä»¶
      if (elements.notes) {
        elements.notes.addEventListener('click', e => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const pack = currentLang === 'cn' ? UI.cn : UI.en;
          
          if (action === 'delete') {
            if (confirm(pack.deleteConfirm)) {
              deleteNote(id);
            }
          }
          if (action === 'done') {
            toggleDone(id);
          }
          if (action === 'set-reminder') {
            openReminderModal(id);
          }
          if (action === 'edit') {
            openEditModal(id);
          }
        });
      }

      // å·²å®Œæˆç¬”è®°æ“ä½œäº‹ä»¶
      if (elements.completedNotesList) {
        elements.completedNotesList.addEventListener('click', e => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const pack = currentLang === 'cn' ? UI.cn : UI.en;
          
          if (action === 'delete') {
            if (confirm(pack.deleteConfirm)) {
              deleteNote(id);
            }
          }
          if (action === 'undo-done') {
            toggleDone(id);
          }
        });
      }

      // æé†’æ“ä½œäº‹ä»¶
      if (elements.reminders) {
        elements.reminders.addEventListener('click', e => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.dataset.id;
          const pack = currentLang === 'cn' ? UI.cn : UI.en;
          
          if (btn.dataset.action === 'delete-reminder') {
            if (confirm(pack.deleteReminderConfirm)) {
              deleteReminder(id);
            }
          }
        });
      }
    }

    // è®¾ç½®æ¨¡æ€æ¡†äº‹ä»¶
    function setupModalEvents() {
      // æé†’æ¨¡æ€æ¡†
      if (elements.closeReminderModal) {
        elements.closeReminderModal.addEventListener('click', () => {
          if (elements.reminderModal) elements.reminderModal.style.display = 'none';
        });
      }
      
      if (elements.cancelReminder) {
        elements.cancelReminder.addEventListener('click', () => {
          if (elements.reminderModal) elements.reminderModal.style.display = 'none';
        });
      }
      
      if (elements.saveReminder) {
        elements.saveReminder.addEventListener('click', () => {
          if (currentNoteId && elements.reminderDateTime && elements.reminderDateTime.value) {
            setReminder(currentNoteId, elements.reminderDateTime.value);
            if (elements.reminderModal) elements.reminderModal.style.display = 'none';
          }
        });
      }

      // ç¼–è¾‘æ¨¡æ€æ¡†
      if (elements.closeEditModal) {
        elements.closeEditModal.addEventListener('click', () => {
          if (elements.editModal) elements.editModal.style.display = 'none';
        });
      }
      
      if (elements.cancelEdit) {
        elements.cancelEdit.addEventListener('click', () => {
          if (elements.editModal) elements.editModal.style.display = 'none';
        });
      }
      
      if (elements.saveEdit) {
        elements.saveEdit.addEventListener('click', () => {
          if (currentNoteId && elements.editTitle && elements.editTitle.value.trim()) {
            updateNote(currentNoteId, elements.editTitle.value.trim(), elements.editContent ? elements.editContent.value.trim() : '');
            if (elements.editModal) elements.editModal.style.display = 'none';
          }
        });
      }

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      window.addEventListener('click', (e) => {
        if (elements.reminderModal && e.target === elements.reminderModal) {
          elements.reminderModal.style.display = 'none';
        }
        if (elements.editModal && e.target === elements.editModal) {
          elements.editModal.style.display = 'none';
        }
      });
    }

    // æ¨¡æ€æ¡†åŠŸèƒ½
    function openReminderModal(noteId) {
      currentNoteId = noteId;
      const note = notes.find(n => n.id === noteId);
      const pack = currentLang === 'cn' ? UI.cn : UI.en;
      
      if (note && note.remindAt) {
        if (elements.reminderModalTitle) elements.reminderModalTitle.textContent = pack.editReminder;
        const remindDate = note.remindAt instanceof Date ? note.remindAt : new Date(note.remindAt);
        if (elements.reminderDateTime) elements.reminderDateTime.value = formatDateTimeLocal(remindDate);
      } else {
        if (elements.reminderModalTitle) elements.reminderModalTitle.textContent = pack.setReminder;
        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´+1å°æ—¶
        const defaultTime = new Date(Date.now() + 60 * 60 * 1000);
        if (elements.reminderDateTime) elements.reminderDateTime.value = formatDateTimeLocal(defaultTime);
      }
      
      if (elements.reminderModal) elements.reminderModal.style.display = 'flex';
    }

    function openEditModal(noteId) {
      currentNoteId = noteId;
      const note = notes.find(n => n.id === noteId);
      
      if (note) {
        if (elements.editTitle) elements.editTitle.value = note.title;
        if (elements.editContent) elements.editContent.value = note.content;
        if (elements.editModal) elements.editModal.style.display = 'flex';
      }
    }

    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // åˆå§‹åŒ–åº”ç”¨
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOM loaded, initializing app...");
      
      // åˆå§‹åŒ–æ‰€æœ‰DOMå…ƒç´ å¼•ç”¨
      initializeElements();
      
      // è®¾ç½®æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
      setTimeout(() => {
        // è®¾ç½®è®¤è¯è¡¨å•
        setupRegisterForm();
        setupLoginForm();
        setupAuthTabs();
        
        // è®¾ç½®ç¬”è®°ç›¸å…³äº‹ä»¶
        setupNoteEvents();
        setupModalEvents();
        
        // è®¾ç½®å…¶ä»–äº‹ä»¶
        if (elements.save) {
          elements.save.addEventListener('click', () => {
            const t = elements.title ? elements.title.value.trim() : '';
            const c = elements.content ? elements.content.value.trim() : '';
            const r = elements.remindAt ? elements.remindAt.value : null;
            createNote(t, c, r);
            if (elements.title) elements.title.value = '';
            if (elements.content) elements.content.value = '';
            if (elements.remindAt) elements.remindAt.value = '';
          });
        }

        if (elements.newNote) {
          elements.newNote.addEventListener('click', () => {
            if (elements.title) elements.title.focus();
          });
        }

        if (elements.fileInput) {
          elements.fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
              importNotes(e.target.files[0]);
              e.target.value = ''; // Reset file input
            }
          });
        }

        if (elements.skipAuth) {
          elements.skipAuth.addEventListener('click', () => {
            hideAuthModal();
            loadLocalNotes();
          });
        }

        if (elements.syncNow) {
          elements.syncNow.addEventListener('click', () => {
            if (currentUser && isUsingCloud) {
              loadCloudNotes();
            }
          });
        }

        if (elements.userAvatar) {
          elements.userAvatar.addEventListener('click', () => {
            if (elements.userDropdown) {
              elements.userDropdown.classList.toggle('active');
            }
          });
        }

        // å…³é—­ä¸‹æ‹‰èœå•å½“ç‚¹å‡»å¤–éƒ¨
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.user-menu') && elements.userDropdown) {
            elements.userDropdown.classList.remove('active');
          }
        });

        // æœç´¢åŠŸèƒ½
        if (elements.q) {
          elements.q.addEventListener('input', () => {
            renderNotes(elements.q.value);
            renderCompletedNotes(elements.q.value);
          });
        }
        
        if (elements.clear) {
          elements.clear.addEventListener('click', () => {
            if (elements.q) elements.q.value = '';
            renderNotes();
            renderCompletedNotes();
          });
        }

        // è¯­è¨€åˆ‡æ¢
        if (elements.lang) {
          elements.lang.addEventListener('click', () => {
            currentLang = currentLang === 'cn' ? 'en' : 'cn';
            if (elements.app) elements.app.setAttribute('data-lang', currentLang);
            applyLang();
            renderNotes(elements.q ? elements.q.value : '');
            renderCompletedNotes(elements.q ? elements.q.value : '');
            renderReminders();
          });
        }

        // ä¸»é¢˜åˆ‡æ¢
        if (elements.theme) {
          elements.theme.addEventListener('click', () => {
            theme = theme === 'dark' ? 'light' : 'dark';
            applyTheme();
          });
        }

        // åˆå§‹åŒ–åº”ç”¨çŠ¶æ€
        loadLocalNotes();
        applyLang();
        applyTheme();
        
        // ä¿®å¤ï¼šç«‹å³æ›´æ–°æ—¶é—´æ˜¾ç¤º
        updateClock();
        
        // ä¿®å¤ï¼šè®¾ç½®æ—¶é—´æ›´æ–°é—´éš”
        setInterval(updateClock, 1000);
        
        setTimeout(checkReminders, 2000);
        updateUserUI();
        
        console.log("App initialized successfully");
      }, 100);
    });
  </script>
</body>
</html>
